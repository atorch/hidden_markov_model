\documentclass[12pt]{article}

\setlength{\parskip}{1em}

\usepackage{amsmath}
\usepackage{graphicx}
\graphicspath{ {./src/} }

\begin{document}

This document describes a hidden Markov model simulation with spatial and temporal correlation
in both land use and classification errors.

The simulation has $T=4$ timeperiods.

The variables of interest are:
\begin{itemize}
\item $S_{it}$, the true land use (hidden state) at pixel $i$ at time $t$;
\item $Y_{it}$, the observation (classifier output, predicted land use) at pixel $i$ at time $t$;
\item $Z_{it}$, the amount of ``clouds'' or ``haze'' or ``noise'' or abstract ``classifier difficulty'' at pixel $i$ at time $t$.
\end{itemize}

All variables are binary.
Think of $S_{it}$ as belonging to a set of two land uses (e.g. $S_{it} \in \left\{\textrm{forest}, \textrm{pasture}\right\}$).
The observations $Y_{it}$ belong to the same set as $S_{it}$. We could expand the set of land uses, but we keep is simple for ease of exposition.

The ``clouds'' / ``haze'' / ``classifier difficulty'' variable $Z_{it}$ can be either ``high'' or ``low''.
Roughly speaking, think of $Z_{it}$ as affecting the probability that the machine learning classifier
makes a mistake, i.e. $Z_{it}$ affects the probability that $Y_{it} \neq S_{it}$.

The pixels $i$ are arranged in a two dimensional square lattice of dimension 100-by-100,
i.e. we observe 10,000 pixels per time period.

The lattice is partitioned into 100 square ``fields'' of 100 pixels each.
Each field measure 10-by-10 pixels.
Intuitively, think of the fields as being parcels of land managed by the same person.

(The fields are equal area squares for convenience: the results would be similar with fields of varying sizes.
That said, square fields are common in certain areas of the world, e.g. 40 acre fields are common across Iowa.)

In this simulation, the true land use $S_{it}$ is always homogeneous (constant) within a given field and a given time period.

The data generating process is as follows:
\begin{itemize}
\item $S_{it}$ follows a first-order Markov process \textit{at the field level}, meaning that we always have $S_{it} = S_{jt}$ when pixels $i$ and $j$ belong to the same field;
\item $Z_{it}$ is generated according to an Ising model in the initial time period, and the values in subsequent time periods are identical, i.e. $Z_{it} = Z_{i,t+1}$, meaning that $Z_{it}$ is perfectly serially correlated (and has some degree of spatial correlation controlled by the Ising ``temperature'' parameter);
\item the observations $Y_{it}$ are generated according to $\Pr\left[Y_{it} \,|\, S_{it}, Z_{it}\right]$. The observations are \textit{conditionally independent} across pixels and across time given $S$ and $Z$. However, note that the spatial and serial correlation in $Z_{it}$ (and in $S_{it}$) can induce spatial and serial correlation in misclassifications (i.e. in the events $Y_{it} \neq S_{it}$), and that we will have spatial correlation in misclassifications even when conditioning on $S_{it}$. $Z_{it}$ can induce spatial correlation in misclassifications within a field, for example.
\end{itemize}

To visualize the simulation, see Figures~\ref{fig:landuses}, \ref{fig:observations}, \ref{fig:classificationerrors} and~\ref{fig:z}.
Think of the green pixels as forest and the other pixels as pasture, for example.

Notice the difference between the 10-by-10 pixel ``fields'' in Figure~\ref{fig:landuses}
versus the noisy observations in Figure~\ref{fig:observations}.

Also note the spatial and temporal correlation in classification errors visible in Figure~\ref{fig:classificationerrors}.

The misclassification probabilities used in this simulation are
\begin{equation}
  \Pr\left[Y \,|\, S, Z_{it} = \textrm{low}\right] =
    \begin{bmatrix}
    0.98 & 0.02 \\
    0.1 & 0.9 \\
    \end{bmatrix}%
\end{equation}
\begin{equation}
  \Pr\left[Y \,|\, S, Z_{it} = \textrm{high}\right] =
    \begin{bmatrix}
    0.82 & 0.18 \\
    0.3 & 0.7 \\
    \end{bmatrix}%
\end{equation}

Think of $Z_{it} = \textrm{high}$ as meaning ``it is hazy/cloudy'' or ``the classifier is more likely to make mistakes at this particular location in space and time.''.

The marginal distribution of $Z_{it}$ is high or low with equal probability, implying overall misclassification probabilities of
\begin{equation}
  0.5 \cdot \Pr\left[Y \,|\, S, Z_{it} = \textrm{high}\right] + 0.5 \cdot \Pr\left[Y \,|\, S, Z_{it} = \textrm{low}\right] =
    \begin{bmatrix}
    0.9 & 0.1 \\
    0.2 & 0.8 \\
    \end{bmatrix}%
\end{equation}


\begin{figure}[h]
  \centering
  \includegraphics{simulation_spatial_corr_true_field_state_ising_beta_1_200_simulations}
  \caption{Simulated Land Uses $S_{it}$\label{fig:landuses}}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics{simulation_spatial_corr_observed_y_1_200_simulations}
  \caption{Simulated Observations $Y_{it}$\label{fig:observations}}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics{simulation_spatial_corr_classification_errors_1_200_simulations}
  \caption{Simulated Classification Errors ($Y_{it} \neq S_{it}$)\label{fig:classificationerrors}}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics{simulation_spatial_corr_z_static_clouds_haze_2_200_simulations}
  \caption{Simulated Classifier Difficulty $Z_{it}$\label{fig:z} With High Spatial Correlation (Ising $\beta = 2$)}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics{simulation_spatial_corr_z_static_clouds_haze_1_200_simulations}
  \caption{Simulated Classifier Difficulty $Z_{it}$\label{fig:z} With Moderate Spatial Correlation (Ising $\beta = 1$)}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics{{{simulation_spatial_corr_z_static_clouds_haze_0.5_200_simulations}}}
  \caption{Simulated Classifier Difficulty $Z_{it}$\label{fig:z} With Low Spatial Correlation (Ising $\beta = 0.5$)}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics{simulation_spatial_corr_z_static_clouds_haze_0_200_simulations}
  \caption{Simulated Classifier Difficulty $Z_{it}$\label{fig:z} With Zero Spatial Correlation (Ising $\beta = 0$)}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics{simulation_spatial_corr_estimated_transition_probabilities_ising_beta_2_200_simulations}
  \caption{Estimated Transition Probabilities (High Spatial Correlation in $Z_{it}$)}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics{simulation_spatial_corr_estimated_transition_probabilities_ising_beta_1_200_simulations}
  \caption{Estimated Transition Probabilities (Moderate Spatial Correlation in $Z_{it}$)}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics{{{simulation_spatial_corr_estimated_transition_probabilities_ising_beta_0.5_200_simulations}}}
  \caption{Estimated Transition Probabilities (Low Spatial Correlation in $Z_{it}$)}
\end{figure}

\begin{figure}[h]
  \centering
  \includegraphics{simulation_spatial_corr_estimated_transition_probabilities_ising_beta_0_200_simulations}
  \caption{Estimated Transition Probabilities (Zero Spatial Correlation in $Z_{it}$)}
\end{figure}

\end{document}
